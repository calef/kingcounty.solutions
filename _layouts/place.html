---
layout: default
---

<article>
  <header>
    {% assign breadcrumb_parents = "" | split: "" %}
    {% assign current_parent = page.parent_place %}
    {% assign all_places_for_breadcrumbs = site.places %}
    {% for i in (0..10) %}
      {% if current_parent %}
        {% assign parent_doc = all_places_for_breadcrumbs | where: "title", current_parent | first %}
        {% if parent_doc %}
          {% if parent_doc.title %}
            {% assign breadcrumb_parents = breadcrumb_parents | push: parent_doc %}
          {% endif %}
          {% assign current_parent = parent_doc.parent_place %}
        {% else %}
          {% capture missing_parent %}
            {{ current_parent }}
          {% endcapture %}
          {% assign missing_parent = missing_parent | strip %}
          {% if missing_parent != "" %}
            {% assign breadcrumb_parents = breadcrumb_parents | push: missing_parent %}
          {% endif %}
          {% assign current_parent = nil %}
        {% endif %}
      {% else %}
        {% break %}
      {% endif %}
    {% endfor %}
    {% assign breadcrumb_parents = breadcrumb_parents | reverse %}
    {% include breadcrumbs.html trail=breadcrumb_parents current=page.title root_url="/places/" root_label="Places" %}
    <h1>{{ page.title }}</h1>
  </header>

  {% assign all_places = site.places | sort: "title" %}
  {% assign child_places = all_places | where: "parent_place", page.title %}
  {% assign all_orgs = site.organizations | sort: "title" %}

  {% assign relevant_places = "" | split: "" %}
  {% assign relevant_places = relevant_places | push: page.title %}
  {% assign current_parent = page.parent_place %}
  {% for i in (0..20) %}
    {% if current_parent %}
      {% unless relevant_places contains current_parent %}
        {% assign relevant_places = relevant_places | push: current_parent %}
      {% endunless %}
      {% assign parent_doc = all_places | where: "title", current_parent | first %}
      {% if parent_doc and parent_doc.parent_place %}
        {% assign current_parent = parent_doc.parent_place %}
      {% else %}
        {% assign current_parent = nil %}
      {% endif %}
    {% else %}
      {% break %}
    {% endif %}
  {% endfor %}

  {% assign relevant_org_titles = "" | split: "" %}
  {% for place_title in relevant_places %}
    {% assign matched_orgs = all_orgs | where_exp: "org", "org.jurisdictions and org.jurisdictions contains place_title" %}
    {% for org in matched_orgs %}
      {% unless relevant_org_titles contains org.title %}
        {% assign relevant_org_titles = relevant_org_titles | push: org.title %}
      {% endunless %}
    {% endfor %}
  {% endfor %}

  {% assign place_news = site.posts | where_exp: "post", "relevant_org_titles contains post.source" %}
  {% assign place_news_total = 0 %}
  {% if place_news and place_news.size > 0 %}
    {% assign place_news = place_news | sort: "date" | reverse %}
    {% assign place_news_total = place_news | size %}
    {% assign place_news = place_news | slice: 0, 20 %}
  {% endif %}

  {% if content %}
    {{ content }}
  {% endif %}

  {% if place_news and place_news.size > 0 %}
    <section>
      <header>
        <h2>News related to {{ page.title }}</h2>
      </header>
        {% for post in place_news %}
          {% include news-item.html post=post %}
      {% endfor %}
      {% if place_news_total > 20 %}
        <p>
          <a href="{{ '/' | relative_url }}">View all news</a>
        </p>
      {% endif %}
    </section>
  {% endif %}

  {% if child_places and child_places.size > 0 %}
    <section>
      <header>
        <h2>Places within {{ page.title }}</h2>
      </header>
      <div class="hierarchy-tree">
        <ul class="hierarchy-tree-list">
          {% for child in child_places %}
            {% include place-tree.html place=child places=all_places %}
          {% endfor %}
        </ul>
      </div>
    </section>
  {% endif %}
</article>
