{% assign carousel_items = include.images | default: empty %}
{% assign carousel_slides = '' | split: '' %}
{% for image_doc in carousel_items %}
  {% if image_doc %}
    {% assign image_url = image_doc.image_url | default: image_doc.data.image_url %}
    {% if image_url %}
      {% assign carousel_slides = carousel_slides | push: image_doc %}
    {% endif %}
  {% endif %}
{% endfor %}
{% assign slide_total = carousel_slides | size %}
{% if include.show_source == false %}
  {% assign carousel_show_source = false %}
{% else %}
  {% assign carousel_show_source = true %}
{% endif %}
{% if slide_total > 0 %}
  <section class="media-carousel-section" aria-label="Images">
    <div class="media-carousel" data-media-carousel data-slide-count="{{ slide_total }}">
      <div class="media-carousel-track" data-carousel-track tabindex="0">
        {% assign first_flag_span = "" %}
        {% for image_doc in carousel_slides %}
          {% assign image_url = image_doc.image_url | default: image_doc.data.image_url %}
          {% assign image_absolute_url = image_url | absolute_url %}
          {% assign current_index = forloop.index0 %}
          {% assign checksum_value = image_doc.data.checksum | default: '' | to_s | strip %}
          {% assign caption_text = image_doc.data.title | to_s | strip %}
          {% if caption_text == checksum_value %}
            {% assign caption_text = '' %}
          {% endif %}
          {% assign alt_text = image_doc.data.alt | default: image_doc.data.alt_text | default: caption_text | default: image_doc.source | default: 'Image' %}
          {% assign alt_text = alt_text | to_s | strip %}
          {% if alt_text == '' or alt_text == checksum_value %}
            {% assign alt_text = 'Image' %}
          {% endif %}
          {% assign source_name = image_doc.source | to_s | strip %}
          {% assign source_url = image_doc.source_url %}
          {% assign caption_source_org = nil %}
          {% if source_name %}
            {% assign caption_source_org = site.organizations | where: "title", source_name | first %}
          {% endif %}
          {% assign image_checksum = image_doc.data.checksum | default: image_doc.checksum | default: '' | strip %}
          {% assign associated_posts = site.posts | where_exp: "post", "post.images and post.images contains image_checksum" %}
          {% if caption_text %}
            {% assign image_title = caption_text %}
          {% else %}
            {% assign image_title = "Image " | append: image_checksum %}
          {% endif %}
          {% capture image_action %}
  - Delete `_images/{{ image_doc.path }}` and remove the stored file at {{ image_absolute_url }}.
  - Remove this checksum from any posts, carousels, or other collections so the image stops rendering.
          {% endcapture %}
        {% assign image_action = image_action | strip %}
        {% capture image_flag_span %}
          {% include flag-issue.html
            mode="data"
            content_type="Image"
            content_title=image_title
            content_url=image_absolute_url
            content_id=image_doc.path
            issue_action=image_action
            associated_posts=associated_posts
          %}
        {% endcapture %}
        {% if forloop.first %}
          {% assign first_flag_span = image_flag_span %}
        {% endif %}
        {% assign has_caption_content = caption_text or (carousel_show_source and (source_name or source_url)) or (associated_posts and associated_posts.size > 0) %}
          <figure class="media-carousel-slide" data-carousel-slide data-carousel-index="{{ current_index }}">
            <img src="{{ image_url | relative_url }}" alt="{{ alt_text | escape }}" loading="{% if current_index == 0 %}eager{% else %}lazy{% endif %}">
            {% if has_caption_content %}
              <figcaption class="media-carousel-caption">
                {% if caption_text %}
                  <span class="media-carousel-caption-text">{{ caption_text | escape }}</span>
                {% endif %}
                {% if carousel_show_source and (source_name or source_url) %}
                  <span class="media-carousel-caption-source">
                    {% if source_name %}<span class="media-carousel-caption-label">Source:</span> {% endif %}
                    {% if caption_source_org %}
                      <a href="{{ caption_source_org.url | relative_url }}">{{ source_name }}</a>
                    {% elsif source_url %}
                      <a href="{{ source_url }}" rel="noopener noreferrer">{{ source_name | default: source_url | escape }}</a>
                    {% elsif source_name %}
                      {{ source_name | escape }}
                    {% else %}
                      <a href="{{ source_url }}" rel="noopener noreferrer">{{ source_url }}</a>
                    {% endif %}
                  </span>
                {% endif %}
                {% if associated_posts and associated_posts.size > 0 %}
                  <span class="media-carousel-caption-posts">
                    <span class="media-carousel-caption-label">Posts:</span>
                    {% for assoc_post in associated_posts %}
                      <a href="{{ assoc_post.url | relative_url }}">{{ assoc_post.title | escape }}</a>{% unless forloop.last %}, {% endunless %}
                    {% endfor %}
                  </span>
                {% endif %}
                {{ image_flag_span }}
              </figcaption>
            {% else %}
              <figcaption class="media-carousel-caption" hidden aria-hidden="true">
                {{ image_flag_span }}
              </figcaption>
            {% endif %}
          </figure>
        {% endfor %}
      </div>
      {% assign default_flag_url = "" %}
      {% assign default_flag_label = "Flag this image for removal" %}
      {% if first_flag_span %}
        {% assign flag_parts = first_flag_span | split: 'data-flag-url="' %}
        {% if flag_parts.size > 1 %}
          {% assign default_flag_url = flag_parts[1] | split: '"' | first %}
        {% endif %}
        {% assign flag_label_parts = first_flag_span | split: 'data-flag-label="' %}
        {% if flag_label_parts.size > 1 %}
          {% assign default_flag_label = flag_label_parts[1] | split: '"' | first %}
        {% endif %}
      {% endif %}
      <div class="media-carousel-controls">
        <button class="media-carousel-button" type="button" data-carousel-prev aria-label="View previous image" disabled>Previous</button>
        <div class="media-carousel-status-row">
          <span class="media-carousel-status" data-carousel-status aria-live="polite">Image 1 of {{ slide_total }}</span>
          <a class="flag-icon media-carousel-flag"
             data-carousel-flag
             href="{{ default_flag_url | default: '#' }}"
             aria-label="{{ default_flag_label }}"
             target="_blank"
             rel="noopener noreferrer">
            {% include flag-icon-svg.html %}
            <span class="sr-only">{{ default_flag_label }}</span>
          </a>
        </div>
        <button class="media-carousel-button" type="button" data-carousel-next aria-label="View next image"{% if slide_total == 1 %} disabled{% endif %}>Next</button>
      </div>
      {% if slide_total > 1 and slide_total <= 30 %}
        <div class="media-carousel-dots" role="tablist" aria-label="Select image to view">
          {% for image_doc in carousel_slides %}
            {% assign dot_index = forloop.index0 %}
            <button class="media-carousel-dot{% if dot_index == 0 %} is-active{% endif %}" type="button" data-carousel-dot data-carousel-target="{{ dot_index }}" aria-label="Go to image {{ dot_index | plus: 1 }} of {{ slide_total }}" aria-current="{% if dot_index == 0 %}true{% else %}false{% endif %}">
              <span class="sr-only">Image {{ dot_index | plus: 1 }} of {{ slide_total }}</span>
            </button>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </section>
{% endif %}
{% if slide_total > 0 and include.load_script != false %}
  <script defer src="{{ '/assets/js/media-carousel.js' | relative_url }}"></script>
{% endif %}
