{% assign carousel_items = include.images | default: empty %}
{% assign carousel_slides = '' | split: '' %}
{% for image_doc in carousel_items %}
  {% if image_doc %}
    {% assign image_url = image_doc.image_url | default: image_doc.data.image_url %}
    {% if image_url %}
      {% assign carousel_slides = carousel_slides | push: image_doc %}
    {% endif %}
  {% endif %}
{% endfor %}
{% assign slide_total = carousel_slides | size %}
{% if include.show_source == false %}
  {% assign carousel_show_source = false %}
{% else %}
  {% assign carousel_show_source = true %}
{% endif %}
{% if slide_total > 0 %}
  <section class="media-carousel-section" aria-label="Images">
    <div class="media-carousel" data-media-carousel data-slide-count="{{ slide_total }}">
      <div class="media-carousel-track" data-carousel-track tabindex="0">
        {% for image_doc in carousel_slides %}
          {% assign image_url = image_doc.image_url | default: image_doc.data.image_url %}
          {% assign current_index = forloop.index0 %}
          {% assign checksum_value = image_doc.data.checksum | default: '' | to_s | strip %}
          {% assign caption_text = image_doc.data.title | to_s | strip %}
          {% if caption_text == checksum_value %}
            {% assign caption_text = '' %}
          {% endif %}
          {% assign alt_text = image_doc.data.alt | default: image_doc.data.alt_text | default: caption_text | default: image_doc.source | default: 'Image' %}
          {% assign alt_text = alt_text | to_s | strip %}
          {% if alt_text == '' or alt_text == checksum_value %}
            {% assign alt_text = 'Image' %}
          {% endif %}
          {% assign source_name = image_doc.source | to_s | strip %}
          {% assign source_url = image_doc.source_url %}
          {% assign caption_source_org = nil %}
          {% if source_name %}
            {% assign caption_source_org = site.organizations | where: "title", source_name | first %}
          {% endif %}
          {% assign image_checksum = image_doc.data.checksum | default: image_doc.checksum | default: '' | strip %}
          {% assign associated_posts = site.posts | where_exp: "post", "post.images and post.images contains image_checksum" %}
          <figure class="media-carousel-slide" data-carousel-slide data-carousel-index="{{ current_index }}">
            <img src="{{ image_url | relative_url }}" alt="{{ alt_text | escape }}" loading="{% if current_index == 0 %}eager{% else %}lazy{% endif %}">
            {% if caption_text or (carousel_show_source and (source_name or source_url)) %}
              <figcaption class="media-carousel-caption">
                {% if caption_text %}
                  <span class="media-carousel-caption-text">{{ caption_text | escape }}</span>
                {% endif %}
                {% if carousel_show_source and (source_name or source_url) %}
                  <span class="media-carousel-caption-source">
                    {% if source_name %}<span class="media-carousel-caption-label">Source:</span> {% endif %}
                    {% if caption_source_org %}
                      <a href="{{ caption_source_org.url | relative_url }}">{{ source_name }}</a>
                    {% elsif source_url %}
                      <a href="{{ source_url }}" rel="noopener noreferrer">{{ source_name | default: source_url | escape }}</a>
                    {% elsif source_name %}
                      {{ source_name | escape }}
                    {% else %}
                      <a href="{{ source_url }}" rel="noopener noreferrer">{{ source_url }}</a>
                    {% endif %}
                  </span>
                {% endif %}
                {% if associated_posts and associated_posts.size > 0 %}
                  <span class="media-carousel-caption-posts">
                    <span class="media-carousel-caption-label">Posts:</span>
                    {% for assoc_post in associated_posts %}
                      <a href="{{ assoc_post.url | relative_url }}">{{ assoc_post.title | escape }}</a>{% unless forloop.last %}, {% endunless %}
                    {% endfor %}
                  </span>
                {% endif %}
              </figcaption>
            {% endif %}
          </figure>
        {% endfor %}
      </div>
      <div class="media-carousel-controls">
        <button class="media-carousel-button" type="button" data-carousel-prev aria-label="View previous image" disabled>Previous</button>
        {% if slide_total > 1 %}
          <span class="media-carousel-status" data-carousel-status aria-live="polite">Image 1 of {{ slide_total }}</span>
        {% endif %}
        <button class="media-carousel-button" type="button" data-carousel-next aria-label="View next image"{% if slide_total == 1 %} disabled{% endif %}>Next</button>
      </div>
      {% if slide_total > 1 and slide_total <= 30 %}
        <div class="media-carousel-dots" role="tablist" aria-label="Select image to view">
          {% for image_doc in carousel_slides %}
            {% assign dot_index = forloop.index0 %}
            <button class="media-carousel-dot{% if dot_index == 0 %} is-active{% endif %}" type="button" data-carousel-dot data-carousel-target="{{ dot_index }}" aria-label="Go to image {{ dot_index | plus: 1 }} of {{ slide_total }}" aria-current="{% if dot_index == 0 %}true{% else %}false{% endif %}">
              <span class="sr-only">Image {{ dot_index | plus: 1 }} of {{ slide_total }}</span>
            </button>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </section>
{% endif %}
{% if slide_total > 0 and include.load_script != false %}
  <script defer src="{{ '/assets/js/media-carousel.js' | relative_url }}"></script>
{% endif %}
