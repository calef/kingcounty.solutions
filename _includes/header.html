<header class="site-header" role="banner">

  <div class="wrapper">
    <a class="site-title" rel="author" href="{{ "/" | relative_url }}">{{ site.title | escape }}</a>

    <nav class="site-nav">
      <input type="checkbox" id="nav-trigger" class="nav-trigger" />
      <label for="nav-trigger">
        <span class="menu-icon">
          <svg viewBox="0 0 18 15" width="18px" height="15px">
            <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
          </svg>
        </span>
      </label>

      <div class="trigger">
        <div class="site-search" role="search">
          <label class="sr-only" for="site-search-input">Search the site</label>
          <div class="site-search-control">
            <input
              type="search"
              id="site-search-input"
              name="site-search-input"
              placeholder="Search {{ site.title }}"
              autocomplete="off"
              autocapitalize="none"
              spellcheck="false"
              aria-describedby="site-search-status"
            >
            <button type="button" id="site-search-clear" class="site-search-clear" aria-label="Clear search" hidden>&times;</button>
          </div>
          <div class="site-search-results" hidden>
            <p class="site-search-status" id="site-search-status" aria-live="polite"></p>
            <ul class="site-search-list" id="site-search-list"></ul>
          </div>
        </div>
        <a class="page-link" href="{{ '/organizations/' | relative_url }}">Organizations</a>
        <a class="page-link" href="{{ '/places/' | relative_url }}">Places</a>
        <a class="page-link" href="{{ '/topics/' | relative_url }}">Topics</a>
      </div>
    </nav>
  </div>
</header>

<style>
.site-search {
  display: inline-block;
  margin: 0 1rem 0 0;
  max-width: none;
  width: 100%;
  flex: 1 1 auto;
  white-space: nowrap;
}
.site-search-control {
  position: relative;
  margin-bottom: 0.4rem;
}
.site-search-control input {
  width: 100%;
  padding: 0.55rem 2.25rem 0.55rem 0.75rem;
  border-radius: 999px;
  border: 1px solid #d0d0d0;
  font-size: 0.9rem;
}
.site-search-control input:focus {
  outline: none;
  border-color: #0366d6;
  box-shadow: 0 0 0 3px rgba(3, 102, 214, 0.15);
}
.site-search-clear {
  position: absolute;
  right: 0.75rem;
  top: 50%;
  transform: translateY(-50%);
  border: none;
  background: transparent;
  font-size: 1.25rem;
  line-height: 1;
  cursor: pointer;
  color: #666;
}
.site-search-results {
  position: absolute;
  left: var(--site-search-left, 0);
  top: var(--site-search-top, 0);
  width: var(--site-search-width, 75vw);
  z-index: 10;
  background: #fff;
  border: 1px solid #e0e0e0;
  border-radius: 0.6rem;
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
  padding: 0.15rem;
  max-height: 60vh;
  overflow-y: auto;
}
.site-search-status {
  margin: 0 0 0.5rem;
  color: #666;
  font-size: 0.95rem;
}
.site-search-list {
  list-style: none;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  gap: 0;
}
.site-search-list li {
  padding: 0;
}
.site-search-row {
  display: flex;
  align-items: center;
  gap: 0;
}
.site-search-list li a {
  text-decoration: none;
  font-weight: 600;
  color: inherit;
  flex: 1 1 auto;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.site-search-list li a:hover {
  text-decoration: underline;
}
.site-search-result-meta {
  display: block;
  margin-top: 0.1rem;
  color: #666;
  font-size: 0.8rem;
  line-height: 1.2;
}
.site-search-pill {
  display: inline-block;
  padding: 0.05rem 0.35rem;
  border-radius: 999px;
  background: #f0f0f0;
  font-size: 0.7rem;
  line-height: 1.1;
  margin-left: 0.3rem;
}
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}
@media screen and (min-width: 601px) {
  .site-nav .trigger {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: nowrap;
    justify-content: flex-end;
  }
  .site-search {
    flex: 1 1 auto;
    min-width: 0;
    width: 100%;
    margin-right: 0.75rem;
  }
  .site-nav .page-link {
    white-space: nowrap;
  }
}
@media screen and (max-width: 600px) {
  .site-search {
    flex: 1 1 auto;
    width: 100%;
    max-width: none;
    min-width: 0;
    margin: 0 0.75rem 0 0;
  }
}
</style>

<script>
(function() {
  const MIN_QUERY = 2;
  const MAX_RESULTS = 20;
  const data = [
    {%- for post in site.posts -%}
      {%- assign post_excerpt = post.excerpt | strip_html | strip_newlines -%}
      {%- if post_excerpt == "" or post_excerpt == nil -%}
        {%- assign post_excerpt = post.content | strip_html | strip_newlines -%}
      {%- endif -%}
      {%- assign post_excerpt = post_excerpt | truncate: 160 -%}
      {
        "title": {{ post.title | jsonify }},
        "url": {{ post.url | relative_url | jsonify }},
        "category": "News",
        "description": {{ post_excerpt | jsonify }}
      }{% unless forloop.last %},{% endunless %}
    {%- endfor -%}
    {% unless site.posts == empty %},{% endunless %}
    {%- for org in site.organizations -%}
      {%- assign org_excerpt = org.content | strip_html | strip_newlines | truncate: 160 -%}
      {
        "title": {{ org.title | jsonify }},
        "url": {{ org.url | relative_url | jsonify }},
        "category": "Organization",
        "description": {{ org_excerpt | jsonify }}
      }{% unless forloop.last %},{% endunless %}
    {%- endfor -%}
    {% unless site.organizations == empty %},{% endunless %}
    {%- for place in site.places -%}
      {%- assign place_excerpt = place.content | strip_html | strip_newlines | truncate: 160 -%}
      {
        "title": {{ place.title | jsonify }},
        "url": {{ place.url | relative_url | jsonify }},
        "category": "Place",
        "description": {{ place_excerpt | jsonify }}
      }{% unless forloop.last %},{% endunless %}
    {%- endfor -%}
    {% unless site.places == empty %},{% endunless %}
    {%- for topic in site.topics -%}
      {%- assign topic_excerpt = topic.content | strip_html | strip_newlines | truncate: 160 -%}
      {
        "title": {{ topic.title | jsonify }},
        "url": {{ topic.url | relative_url | jsonify }},
        "category": "Topic",
        "description": {{ topic_excerpt | jsonify }}
      }{% unless forloop.last %},{% endunless %}
    {%- endfor -%}
    {% unless site.topics == empty %},{% endunless %}
    {%- assign searchable_pages = site.pages | where_exp: "p", "p.title and p.title != ''" -%}
    {%- for page in searchable_pages -%}
      {%- if page.url contains '/assets/' or page.url contains '/_site/' -%}
        {%- continue -%}
      {%- endif -%}
      {%- assign page_excerpt = page.content | strip_html | strip_newlines | truncate: 160 -%}
      {
        "title": {{ page.title | jsonify }},
        "url": {{ page.url | relative_url | jsonify }},
        "category": "Page",
        "description": {{ page_excerpt | jsonify }}
      }{% unless forloop.last %},{% endunless %}
    {%- endfor -%}
  ];

  const categoryCounts = {};
  data.forEach(item => {
    const key = item.category || 'Other';
    categoryCounts[key] = (categoryCounts[key] || 0) + 1;
  });

  const index = data.map(item => {
    const searchText = [item.title, item.description, item.category]
      .filter(Boolean)
      .join(' ')
      .toLowerCase();
    return Object.assign({}, item, { searchText });
  });

  const input = document.getElementById('site-search-input');
  if (!input) return;
  const clearBtn = document.getElementById('site-search-clear');
  const status = document.getElementById('site-search-status');
  const list = document.getElementById('site-search-list');
  const results = document.querySelector('.site-search-results');

  function updateStatus(message) {
    if (status) status.textContent = message;
  }

  function setResultsPosition() {
    if (!results || results.hidden) return;
    const nav = document.querySelector('.site-header .site-nav');
    const rect = nav ? nav.getBoundingClientRect() : input.getBoundingClientRect();
    const width = window.innerWidth * 0.75;
    const left = (window.innerWidth - width) / 2;
    const top = rect.bottom + window.scrollY + 12;
    results.style.setProperty('--site-search-left', `${left}px`);
    results.style.setProperty('--site-search-top', `${top}px`);
    results.style.setProperty('--site-search-width', `${width}px`);
  }

  function renderResults(items, total) {
    if (results) results.hidden = false;
    setResultsPosition();
    if (!list) return;
    if (items.length === 0) {
      list.innerHTML = '';
      updateStatus('No matches found.');
      return;
    }
    const limited = items.slice(0, MAX_RESULTS);
    list.innerHTML = limited.map(item => {
      const meta = item.category ? `<span class="site-search-pill">${item.category}</span>` : '';
      return `
        <li>
          <div class="site-search-row">
            <a href="${item.url}">${item.title}</a>
            ${meta}
          </div>
        </li>
      `;
    }).join('');

    updateStatus('');
  }

  function handleSearch() {
    const query = input.value.trim();
    const hasValue = query.length > 0;
    clearBtn.hidden = !hasValue;

    if (query.length < MIN_QUERY) {
      if (results) results.hidden = true;
      list.innerHTML = '';
      updateStatus('');
      return;
    }

    const tokens = query.toLowerCase().split(/\s+/).filter(Boolean);
    const matches = index.filter(item => tokens.every(token => item.searchText.includes(token)));
    if (matches.length === 0) {
      renderResults([], 0);
      return;
    }

    const grouped = {};
    matches.forEach(item => {
      const key = item.category || 'Other';
      (grouped[key] = grouped[key] || []).push(item);
    });
    Object.keys(grouped).forEach(key => {
      grouped[key].sort((a, b) => a.title.localeCompare(b.title));
    });

    const categoryOrder = Object.keys(grouped).sort((a, b) => {
      const countA = categoryCounts[a] || 0;
      const countB = categoryCounts[b] || 0;
      if (countA !== countB) {
        return countA - countB;
      }
      return a.localeCompare(b);
    });

    const ranked = [];
    while (ranked.length < MAX_RESULTS) {
      let added = false;
      for (const category of categoryOrder) {
        const bucket = grouped[category];
        if (bucket && bucket.length) {
          ranked.push(bucket.shift());
          added = true;
          if (ranked.length >= MAX_RESULTS) {
            break;
          }
        }
      }
      if (!added) break;
    }

    renderResults(ranked, matches.length);
  }

  function clearResults() {
    input.value = '';
    clearBtn.hidden = true;
    list.innerHTML = '';
    updateStatus('');
    if (results) results.hidden = true;
  }

  clearBtn.addEventListener('click', () => {
    clearResults();
    input.focus();
  });
  input.addEventListener('input', handleSearch);
  input.addEventListener('focus', handleSearch);

  document.addEventListener('keydown', (event) => {
    if ((event.metaKey || event.ctrlKey) && event.key.toLowerCase() === 'k') {
      event.preventDefault();
      input.focus();
    }
    if (event.key === 'Escape' && document.activeElement === input) {
      clearResults();
    }
  });

  window.addEventListener('resize', setResultsPosition);
  window.addEventListener('scroll', setResultsPosition, { passive: true });
})();
</script>
