#!/usr/bin/env ruby
# frozen_string_literal: true

require 'optparse'
require 'ruby/openai'
require_relative '../lib/topic_audit'

def parse_options(default_model:, default_max_posts:)
  options = {
    model: default_model,
    max_posts: default_max_posts,
    force: false,
    output: nil,
    apply: false
  }

  OptionParser.new do |opts|
    opts.banner = 'Usage: bin/audit-topics [options]'

    opts.on('--model MODEL', "OpenAI model (default: #{default_model})") { |model| options[:model] = model }
    opts.on('--max-posts N', Integer, "Number of recent posts per org to include (default: #{default_max_posts})") { |n| options[:max_posts] = n }
    opts.on('--force', 'Ignore cached responses and re-run audit') { options[:force] = true }
    opts.on('--output FILE', 'Write JSON report to FILE') { |file| options[:output] = file }
    opts.on('--apply', 'Update organization topic lists in-place') { options[:apply] = true }
  end.parse!

  options
end

if $PROGRAM_NAME == __FILE__
  options = parse_options(
    default_model: TopicAudit::DEFAULT_MODEL,
    default_max_posts: TopicAudit::DEFAULT_MAX_POSTS
  )
  client = OpenAI::Client.new(access_token: ENV.fetch('OPENAI_API_KEY'))
  TopicAudit::OrganizationAudit.new(client: client, options: options).run
end
