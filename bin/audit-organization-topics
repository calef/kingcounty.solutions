#!/usr/bin/env ruby
# frozen_string_literal: true

require 'optparse'
require 'ruby/openai'
require_relative '../lib/mayhem/topics/organization_audit'

def parse_options(default_model:, default_max_posts:)
  options = default_options(default_model, default_max_posts)

  OptionParser.new do |opts|
    opts.banner = 'Usage: bin/audit-topics [options]'

    configure_model_option(opts, default_model, options)
    configure_max_posts_option(opts, default_max_posts, options)
    configure_force_option(opts, options)
    configure_output_option(opts, options)
    configure_apply_option(opts, options)
  end.parse!

  options
end

def default_options(default_model, default_max_posts)
  {
    model: default_model,
    max_posts: default_max_posts,
    force: false,
    output: nil,
    apply: false
  }
end

def configure_model_option(opts, default_model, options)
  opts.on('--model MODEL', "OpenAI model (default: #{default_model})") do |model|
    options[:model] = model
  end
end

def configure_max_posts_option(opts, default_max_posts, options)
  opts.on('--max-posts N', Integer,
          "Number of recent posts per org to include (default: #{default_max_posts})") do |n|
    options[:max_posts] = n
  end
end

def configure_force_option(opts, options)
  opts.on('--force', 'Ignore cached responses and re-run audit') { options[:force] = true }
end

def configure_output_option(opts, options)
  opts.on('--output FILE', 'Write JSON report to FILE') { |file| options[:output] = file }
end

def configure_apply_option(opts, options)
  opts.on('--apply', 'Update organization topic lists in-place') { options[:apply] = true }
end

if $PROGRAM_NAME == __FILE__
  defaults = {
    default_model: Mayhem::Topics::OrganizationAudit::DEFAULT_MODEL,
    default_max_posts: Mayhem::Topics::OrganizationAudit::DEFAULT_MAX_POSTS
  }
  options = parse_options(**defaults)
  client = OpenAI::Client.new(access_token: ENV.fetch('OPENAI_API_KEY'))
  audit = Mayhem::Topics::OrganizationAudit.new(
    client: client,
    model: options[:model],
    max_posts: options[:max_posts],
    force: options[:force],
    output: options[:output],
    apply: options[:apply]
  )
  audit.run
end
