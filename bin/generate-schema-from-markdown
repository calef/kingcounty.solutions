#!/usr/bin/env ruby
# frozen_string_literal: true

require 'yaml'

# === Configuration ===
SOURCE_DIR = ARGV[0] || '_government-entities' # Default directory
TOP_KEY = File.basename(SOURCE_DIR).sub(/^_/, '') + '_schema'

# Helper for Ruby < 3.2 to avoid nil.presence
class Object
  def presence
    self unless respond_to?(:empty?) && empty?
  end
end

# === Utility: Extract front matter from a markdown file ===
def extract_front_matter(path)
  content = File.read(path)
  if content =~ /\A---\s*\n(.*?)\n---\s*\n/m
    YAML.safe_load(Regexp.last_match(1))
  else
    {}
  end
rescue Psych::SyntaxError => e
  warn "⚠️  YAML error in #{path}: #{e.message}"
  {}
end

# === Normalize example values for clean output ===
def normalize_value(value)
  case value
  when String
    value.strip
  when Numeric, TrueClass, FalseClass
    value
  when Array
    value.map { |v| normalize_value(v) }.join(', ')
  when Hash
    value.to_s
  else
    value.to_s
  end
end

# === Aggregate all keys and values ===
schema = Hash.new do |h, k|
  h[k] = { 'description' => nil, 'examples' => Set.new, 'possible_values' => Set.new, 'types' => Set.new }
end

Dir.glob(File.join(SOURCE_DIR, '**/*.md')).each do |file|
  data = extract_front_matter(file)
  next unless data.is_a?(Hash)

  data.each do |key, value|
    entry = schema[key]
    example = normalize_value(value)
    entry['examples'] << example if entry['examples'].size < 5

    case value
    when String
      entry['types'] << 'string'
    when Integer
      entry['types'] << 'integer'
    when Float
      entry['types'] << 'float'
    when TrueClass, FalseClass
      entry['types'] << 'boolean'
      entry['possible_values'] << value
    when Array
      entry['types'] << 'array'
      value.each do |v|
        entry['possible_values'] << normalize_value(v) if v.is_a?(String) && entry['possible_values'].size <= 12
      end
    when Hash
      entry['types'] << 'object'
    else
      entry['types'] << value.class.to_s.downcase
    end
  end
end

# === Simplify and format schema ===
schema_yaml = schema.transform_values do |info|
  {
    'description' => info['description'] || 'TODO: describe this attribute',
    'type' => info['types'].to_a.join(' | '),
    'possible_values' => info['possible_values'].to_a.sort.presence,
    'examples' => info['examples'].to_a.sort.presence
  }.compact
end

# === Wrap in top-level key and print ===
puts({ TOP_KEY => schema_yaml }.to_yaml)
