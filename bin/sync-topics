#!/usr/bin/env ruby
require 'yaml'
require 'fileutils'
require 'set'

CONFIG_FILE = "_config.yml"
TOPICS_DIR = "_topics"

# --- Helper: normalize a subtopic name to a safe filename ---
def subtopic_to_filename(subtopic)
  base = subtopic.to_s.strip.downcase
  base = base.gsub(/[\/\\]/, '-')       # convert / and \ to -
  base = base.gsub(/\s+/, '-')          # spaces -> hyphens
  base = base.gsub(/-+/, '-')           # collapse multiple hyphens
  base = base.gsub(/[^a-z0-9\-]/, '')   # remove non-alphanumeric/non-hyphen
  base = base.gsub(/^\-+|\-+$/, '')     # trim leading/trailing hyphens
  base
end

# --- Load _config.yml ---
unless File.exist?(CONFIG_FILE)
  warn "Error: #{CONFIG_FILE} not found."
  exit 1
end

config = YAML.load_file(CONFIG_FILE)
topics_hash = config["topics"]

unless topics_hash && topics_hash.is_a?(Hash)
  warn "Error: 'topics' key not found or invalid in #{CONFIG_FILE}."
  exit 1
end

# --- Ensure _topics directory exists ---
FileUtils.mkdir_p(TOPICS_DIR)

# --- Existing subtopic files ---
existing_files = Dir.glob("#{TOPICS_DIR}/*.md").map { |f| File.basename(f, ".md") }

# --- Collect subtopics and create files ---
all_subtopic_bases = Set.new

topics_hash.each do |topic, subtopics|
  next unless subtopics.is_a?(Array)

  subtopics.each do |subtopic|
    filename_base = subtopic_to_filename(subtopic)
    all_subtopic_bases << filename_base
    filename = File.join(TOPICS_DIR, "#{filename_base}.md")

    unless File.exist?(filename)
      puts "Creating #{filename}"
      File.open(filename, "w") do |f|
        f.puts("---")
        f.puts("title: \"#{subtopic}\"")
        f.puts("topic: \"#{topic}\"")
        f.puts("---")
        f.puts
      end
    end
  end
end

# --- Remove files not present in config ---
files_to_delete = existing_files.reject { |f| all_subtopic_bases.include?(f) }
files_to_delete.each do |old_file|
  path = File.join(TOPICS_DIR, "#{old_file}.md")
  puts "Removing #{path}"
  File.delete(path)
end

puts "Subtopic sync complete."
